<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Tutor v15 | Chart Engine Restored</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-rtl@1.0.1/dist/chartjs-plugin-rtl.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        persian: ['Vazirmatn', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: "rgba(30, 41, 59, 0.8)",
                        accent: "#38bdf8",
                        accentHover: "#0284c7",
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* === LAYOUT === */
        body { 
            background-color: #0f172a;
            color: #e2e8f0;
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }

        header { flex-shrink: 0; }
        main { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; }
        footer { flex-shrink: 0; background: #0f172a; border-top: 1px solid rgba(255,255,255,0.05); z-index: 40; }

        /* === TYPOGRAPHY === */
        .markdown-content {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            line-height: 2.2; 
            direction: rtl;
            text-align: right;
            font-size: 1.05rem;
        }
        
        .markdown-content strong { color: #38bdf8; font-weight: 700; }
        .markdown-content em { color: #facc15; font-style: italic; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #e879f9; font-weight: 700; margin-top: 2rem; margin-bottom: 1.25rem;
        }

        .markdown-content p, .markdown-content li { position: relative; padding-left: 24px; margin-bottom: 1.5rem; }
        .markdown-content ul, .markdown-content ol { padding-right: 1.5rem; margin-bottom: 1rem; list-style-position: inside; }
        
        /* Math & Code */
        .markdown-content code:not(pre code), .katex {
            direction: ltr; unicode-bidi: isolate;
            font-family: 'JetBrains Mono', monospace;
            background-color: rgba(255, 255, 255, 0.08);
            padding: 0.2rem 0.4rem; border-radius: 0.3rem; font-size: 0.9em;
            margin: 0 3px; display: inline-block; color: #a5b4fc;
        }
        .katex-display {
            direction: ltr; overflow-x: auto; padding: 1rem;
            background: rgba(0,0,0,0.3); border-radius: 8px; margin: 1rem 0;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Chart & Output */
        .exec-output {
            background: #fff; border-radius: 8px; padding: 1rem;
            margin-bottom: 1.5rem; display: none; width: 100%;
        }
        .chart-container { position: relative; height: 400px !important; width: 100%; }

        /* Bookmarking */
        .pin-btn {
            position: absolute; left: 0; top: 6px;
            opacity: 0; cursor: pointer; color: #475569;
            transition: all 0.2s; padding: 4px; z-index: 10;
        }
        .markdown-content *:hover > .pin-btn, .pin-btn.active-pin { opacity: 1; }
        .pin-btn:hover { color: #38bdf8; transform: scale(1.1); }
        .pin-btn.active-pin { color: #38bdf8; }

        #bookmarksPanel {
            position: fixed; right: 20px; top: 100px;
            width: 40px; max-height: 70vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; z-index: 50;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #bookmarksPanel.expanded, #bookmarksPanel:hover { width: 280px; }
        
        .bookmark-item {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem; color: #cbd5e1; display: flex; align-items: center; gap: 10px;
            white-space: nowrap; transition: background 0.2s;
        }
        .bookmark-item:hover { background: rgba(56, 189, 248, 0.1); }
        .bookmark-text { overflow: hidden; text-overflow: ellipsis; cursor: pointer; flex: 1; text-align: right; direction: rtl; }
        
        .run-code-btn {
            display: inline-flex; align-items: center; gap: 6px;
            background: #2563eb; color: white; padding: 8px 16px;
            border-radius: 8px; font-size: 0.9rem; font-weight: 600;
            margin: 0.5rem 0 1.5rem 0; cursor: pointer; transition: all 0.2s;
            border: 1px solid #3b82f6;
        }
        .run-code-btn:hover { background: #1d4ed8; }
        .run-code-btn:disabled { background: #334155; cursor: not-allowed; }

        /* Loading Indicator */
        .typing-dot { width: 6px; height: 6px; background: #38bdf8; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .remove-item { cursor: pointer; color: #f87171; }
        .remove-item:hover { color: #ef4444; transform: scale(1.1); }
        
        .mac-terminal { margin: 1rem 0; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
        .mac-header { background: #1f2937; padding: 8px; display: flex; justify-content: space-between; align-items: center; }
        .mac-terminal pre { margin: 0; background: #111827; padding: 1rem; overflow-x: auto; }
    </style>
</head>
<body>

    <!-- Bookmarks Panel -->
    <div id="bookmarksPanel">
        <div class="p-3 flex items-center justify-center border-b border-white/10 cursor-pointer bg-slate-800/50">
            <i data-lucide="bookmark" class="text-accent w-5 h-5"></i>
        </div>
        <div id="bookmarksList" class="overflow-y-auto max-h-[60vh] opacity-0 hover:opacity-100 transition-opacity duration-200 delay-100">
            <div class="p-6 text-center text-xs text-slate-500 italic" id="emptyBookmarksMsg">No bookmarks yet.<br>Hover over text to pin.</div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass bg-slate-900/90 p-4 flex justify-between items-center border-b border-white/5 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-accent/20 p-2 rounded-xl border border-accent/10">
                <i data-lucide="graduation-cap" class="text-accent w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-white">Gemini Tutor v15</h1>
                <p class="text-xs text-slate-400">Fixed Chart Engine (v8 Logic)</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <input type="password" id="apiKeyInput" placeholder="API Key" 
                class="bg-slate-800/50 border border-slate-600 text-sm rounded-lg w-28 md:w-48 px-3 py-2 text-white focus:border-accent outline-none transition-all">
            <button onclick="saveApiKey()" class="bg-accent hover:bg-accentHover text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition-colors">
                Set Key
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chatContainer" class="p-4 md:p-8 space-y-8 scroll-smooth">
        <!-- Empty State -->
        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-center space-y-8 opacity-80 min-h-[50vh]">
            <div class="bg-slate-800/50 p-8 rounded-full border border-white/5 ring-1 ring-white/10 shadow-2xl">
                <i data-lucide="book-open-check" class="w-16 h-16 text-accent/80"></i>
            </div>
            <div class="space-y-4">
                <h2 class="text-3xl font-bold text-white font-persian">دستیار آموزشی هوشمند</h2>
                <p class="text-slate-400 max-w-lg mx-auto font-persian leading-8">
                    فایل‌های خود را آپلود کنید.<br>
                    من با استفاده از موتور بازسازی شده (v8) نمودارها را دقیق رسم می‌کنم<br>
                    و محتوا را گام‌به‌گام به شما آموزش می‌دهم.
                </p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="p-4 md:p-6 bg-slate-900/90 backdrop-blur-md">
        <div class="max-w-4xl mx-auto rounded-2xl flex flex-col">
            
            <div id="previewArea" class="flex flex-wrap gap-2 px-1 mb-2 hidden"></div>

            <div id="urlInputContainer" class="hidden px-1 mb-3 animate-fade-in-up">
                <div class="flex gap-2">
                    <input type="text" id="urlInput" placeholder="https://example.com/article" 
                        class="bg-slate-800/80 border border-slate-600 rounded-lg flex-1 px-3 py-2 text-sm text-white focus:border-accent outline-none">
                    <button onclick="addUrl()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-xs font-bold">ADD</button>
                </div>
            </div>

            <div class="flex items-end gap-3">
                <button onclick="document.getElementById('fileInput').click()" class="text-slate-400 hover:text-white p-3 hover:bg-white/10 rounded-full transition-all" title="Upload Files">
                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                </button>
                <input type="file" id="fileInput" class="hidden" multiple accept="application/pdf,application/epub+zip,image/*,text/plain" onchange="handleFileUpload(this)">

                <button onclick="toggleUrlInput()" class="text-slate-400 hover:text-white p-3 hover:bg-white/10 rounded-full transition-all" title="Add URL">
                    <i data-lucide="link" class="w-5 h-5"></i>
                </button>

                <textarea id="userInput" rows="1" 
                    class="w-full bg-slate-800/50 border border-slate-700 text-white p-3 max-h-40 rounded-xl focus:outline-none focus:border-accent resize-none font-persian text-right placeholder-slate-500 text-base" 
                    placeholder="سوال خود را بپرسید..."></textarea>
                
                <button onclick="sendMessage()" id="sendBtn" class="bg-white text-slate-900 hover:bg-slate-200 p-3 rounded-full shadow-lg hover:scale-105 transition-all">
                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </footer>

    <!-- Templates -->
    <template id="userMsgTemplate">
        <div class="flex justify-end animate-fade-in-up">
            <div class="bg-slate-700 text-white px-6 py-4 rounded-3xl rounded-tr-sm max-w-[85%] shadow-md border border-slate-600">
                <div class="attachments-container mb-2 hidden flex gap-2 flex-wrap"></div>
                <p class="text-base leading-relaxed dir-rtl text-right font-persian whitespace-pre-wrap"></p>
            </div>
        </div>
    </template>

    <template id="aiMsgTemplate">
        <div class="flex justify-start animate-fade-in-up w-full">
            <div class="glass text-slate-100 px-6 py-6 rounded-3xl rounded-tl-sm max-w-[95%] md:max-w-[85%] shadow-xl border-l-4 border-l-accent w-full bg-slate-800/60">
                <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bot" class="w-4 h-4 text-accent"></i>
                        <span class="text-xs font-mono text-slate-400 font-bold">GEMINI TUTOR</span>
                    </div>
                </div>
                <div class="markdown-content text-lg"></div>
            </div>
        </div>
    </template>

    <template id="processingTemplate">
        <div class="flex justify-start animate-fade-in-up w-full" id="processingIndicator">
            <div class="glass text-slate-100 px-6 py-4 rounded-3xl rounded-tl-sm shadow-xl border-l-4 border-l-slate-500 bg-slate-800/60 flex items-center gap-4">
                <div class="bg-slate-700/50 p-2 rounded-full animate-pulse-slow">
                    <i data-lucide="brain-circuit" class="w-5 h-5 text-accent"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-slate-200">Thinking...</span>
                    <span class="text-xs text-slate-500 font-mono" id="processStatus">Analyzing content...</span>
                </div>
                <div class="flex gap-1 ml-2">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let chatHistory = [];
        let activeFiles = [];
        let activeUrls = [];
        let bookmarks = [];

        // --- SYSTEM INSTRUCTION (v8 Base + Enhancements) ---
        const SYSTEM_INSTRUCTION = `
You are a "Professional Academic Tutor" powered by Gemini.
Role: Warm, fluent, eloquent, and mathematically precise.

*** CORE PROTOCOL: FILE HANDLING ***
1. **ANALYZE:** Silently read and internalize all uploaded content.
2. **CHECK FILE TYPE:**
   - **IF PDF or EPUB:** Do NOT explain immediately. You MUST ask:
     "I have analyzed the document. To structure our session effectively, please tell me: **From which page to which page would you like to start?**"
     (Wait for the user's response).
   - **IF IMAGE/TEXT/OTHER:** Start teaching the first logical segment immediately.

*** PEDAGOGY: GUIDED LEARNING ***
1. **INTERNALIZE FIRST:** Understand then teach in your own words.
2. **INCREMENTAL TEACHING:** Break topics into small, digestible chunks.
3. **TONE:** Be simple, clear, and friendly.

*** VISUAL & FORMATTING RULES ***
1. **Math:** LaTeX ($...$ or $$...$$) is mandatory.
2. **Charts (Accuracy Protocol):**
   - **EXTRACT** title/topic.
   - **VALIDATE** against scientific laws (e.g., TU Max = MU 0). FORCE data to be perfect.
   - **GENERATE** Chart.js config.
   - **Output a SINGLE \`javascript\` block.**
   - **Define \`const config = { ... }\`.**
   - **NO \`new Chart()\` or \`document.getElementById\`.**
   - Use 'Vazirmatn' font.
`;

        // --- Core Functions ---
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                apiKey = key;
                alert("API Key Saved!");
            }
        }

        function toggleUrlInput() {
            const el = document.getElementById('urlInputContainer');
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) document.getElementById('urlInput').focus();
        }

        function addUrl() {
            const input = document.getElementById('urlInput');
            const url = input.value.trim();
            if(url) {
                activeUrls.push(url);
                input.value = '';
                toggleUrlInput();
                renderPreviews();
            }
        }

        function removeUrl(index) { activeUrls.splice(index, 1); renderPreviews(); }
        function removeFile(index) { activeFiles.splice(index, 1); renderPreviews(); }

        // --- RESTORED v8 CHART EXECUTION LOGIC (PROVEN STABLE) ---
        async function runChartCode(code, outputDivId, btnId) {
            const outputDiv = document.getElementById(outputDivId);
            const btn = document.getElementById(btnId);
            
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i> Rendering...';
            lucide.createIcons();
            
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = ''; 

            try {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                outputDiv.appendChild(chartContainer);
                const canvas = document.createElement('canvas');
                chartContainer.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                
                // 1. Clean Code
                const cleanCode = code.replace(/new\s+Chart\s*\(/g, '//').replace(/document\.getElementById/g, '//');
                
                // 2. Wrap & Eval (v8 Logic)
                const wrappedCode = `(function(){ ${cleanCode}; return typeof config!=='undefined'?config:null; })()`;
                const configObject = eval(wrappedCode);

                if (!configObject) throw new Error("Config object not found. Ensure code defines 'const config = ...'");
                
                // 3. Render
                new Chart(ctx, configObject);
                
            } catch (err) {
                outputDiv.innerHTML = `<div class="text-red-400 text-xs p-2">Error: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> Update Chart';
                lucide.createIcons();
            }
        }

        function toggleBookmark(elementId, text, pinElement) {
            const index = bookmarks.findIndex(b => b.id === elementId);
            if (index !== -1) { bookmarks.splice(index, 1); updatePinVisuals(); } 
            else { 
                const preview = text.substring(0, 35) + (text.length > 35 ? '...' : '');
                bookmarks.push({ id: elementId, text: preview }); 
                updatePinVisuals(); 
            }
            renderBookmarks();
        }

        function removeBookmarkById(elementId) {
            const index = bookmarks.findIndex(b => b.id === elementId);
            if (index !== -1) { bookmarks.splice(index, 1); updatePinVisuals(); renderBookmarks(); }
        }

        function updatePinVisuals() {
            document.querySelectorAll('.pin-btn').forEach(btn => btn.classList.remove('active-pin'));
            bookmarks.forEach(b => {
                const pin = document.querySelector(`#${b.id} .pin-btn`);
                if (pin) pin.classList.add('active-pin');
            });
        }

        function renderBookmarks() {
            const list = document.getElementById('bookmarksList');
            const msg = document.getElementById('emptyBookmarksMsg');
            if (bookmarks.length > 0) {
                if(msg) msg.style.display = 'none';
                list.innerHTML = ''; 
                bookmarks.forEach(b => {
                    const item = document.createElement('div');
                    item.className = 'bookmark-item';
                    item.innerHTML = `
                        <div class="flex items-center gap-2 flex-1 overflow-hidden" onclick="document.getElementById('${b.id}').scrollIntoView({ behavior: 'smooth', block: 'center' })">
                             <i data-lucide="map-pin" class="w-3 h-3 text-accent shrink-0"></i> 
                             <span class="bookmark-text">${b.text}</span>
                        </div>
                        <i data-lucide="x" class="remove-item w-3 h-3" onclick="removeBookmarkById('${b.id}')" title="Unpin"></i>
                    `;
                    list.appendChild(item);
                });
            } else { if(msg) msg.style.display = 'block'; list.innerHTML = ''; list.appendChild(msg); }
            lucide.createIcons();
        }

        function enableBookmarking(container) {
            const targets = container.querySelectorAll('p, h2, h3, h4, li');
            targets.forEach((el, index) => {
                if (!el.id) el.id = `para-${Date.now()}-${index}`;
                const pin = document.createElement('span');
                pin.className = 'pin-btn';
                pin.innerHTML = '<i data-lucide="pin" class="w-4 h-4"></i>';
                pin.title = "Toggle Pin";
                pin.onclick = (e) => { e.stopPropagation(); toggleBookmark(el.id, el.innerText, pin); };
                el.appendChild(pin);
            });
            updatePinVisuals();
            lucide.createIcons();
        }

        function showProcessing() {
            const tpl = document.getElementById('processingTemplate');
            const clone = tpl.content.cloneNode(true);
            document.getElementById('chatContainer').appendChild(clone);
            const status = document.getElementById('processStatus');
            const msgs = ["Internalizing content...", "Structuring explanation...", "Validating logic...", "Preparing response..."];
            let i = 0;
            const interval = setInterval(() => {
                if(status) {
                    status.textContent = msgs[i % msgs.length];
                    i++;
                }
            }, 1500);
            
            const c = document.getElementById('chatContainer');
            c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' });
            return { element: document.getElementById('processingIndicator'), interval: interval };
        }

        function hideProcessing(handle) {
            if(handle && handle.element) {
                handle.element.remove();
                clearInterval(handle.interval);
            }
        }

        function appendAIMessage(rawMarkdown) {
            const tpl = document.getElementById('aiMsgTemplate');
            const clone = tpl.content.cloneNode(true);
            const contentDiv = clone.querySelector('.markdown-content');

            try {
                contentDiv.innerHTML = marked.parse(rawMarkdown);
                enableBookmarking(contentDiv);
                renderMathInElement(contentDiv, {
                    delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}],
                    throwOnError: false
                });

                const terminals = contentDiv.querySelectorAll('.mac-terminal');
                terminals.forEach(term => {
                    const lang = term.getAttribute('data-lang');
                    const code = decodeURIComponent(term.getAttribute('data-code'));
                    if (lang === 'javascript') {
                        const uniqueId = 'exec-' + Math.random().toString(36).substr(2, 9);
                        const btnId = 'btn-' + uniqueId;
                        const container = document.createElement('div');
                        const btn = document.createElement('button');
                        btn.id = btnId;
                        btn.className = 'run-code-btn';
                        btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> Run Chart';
                        btn.onclick = function() { runChartCode(code, uniqueId, btnId); };
                        const output = document.createElement('div');
                        output.id = uniqueId;
                        output.className = 'exec-output';
                        container.append(btn, output);
                        term.parentNode.insertBefore(container, term.nextSibling);
                    }
                });
            } catch (e) { console.error(e); contentDiv.textContent = "Error rendering content."; }

            document.getElementById('chatContainer').appendChild(clone);
            const c = document.getElementById('chatContainer');
            c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' });
            lucide.createIcons();
        }

        function appendUserMessage(text) {
            const tpl = document.getElementById('userMsgTemplate');
            const clone = tpl.content.cloneNode(true);
            clone.querySelector('p').textContent = text;
            const ac = clone.querySelector('.attachments-container');
            
            if (activeFiles.length > 0 || activeUrls.length > 0) {
                ac.classList.remove('hidden');
                activeFiles.forEach(f => {
                    ac.innerHTML += `<span class="bg-slate-600 text-xs px-2 py-1 rounded border border-white/10 flex items-center gap-1"><i data-lucide="file" class="w-3 h-3"></i> ${f.name}</span>`;
                });
                activeUrls.forEach(u => {
                    ac.innerHTML += `<span class="bg-green-700/50 text-green-200 text-xs px-2 py-1 rounded border border-green-500/20 flex items-center gap-1"><i data-lucide="link" class="w-3 h-3"></i> ${u}</span>`;
                });
            }
            document.getElementById('chatContainer').appendChild(clone);
            const c = document.getElementById('chatContainer');
            c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' });
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const text = userInput.value.trim();
            if (!text && activeFiles.length === 0 && activeUrls.length === 0) return;
            if (!apiKey) { alert("Please set API Key"); return; }

            document.getElementById('emptyState').style.display = 'none';
            userInput.value = '';
            
            appendUserMessage(text);
            
            let finalPrompt = text;
            if (activeUrls.length > 0) {
                finalPrompt += "\n\n[System] Analyze these URLs:\n" + activeUrls.join('\n');
            }

            const parts = [{ text: finalPrompt }];
            activeFiles.forEach(f => parts.push({ inlineData: { mimeType: f.mimeType, data: f.data } }));
            
            const history = chatHistory.map(h => ({ role: h.role, parts: h.parts }));
            history.push({ role: "user", parts: parts });

            activeFiles = []; 
            activeUrls = [];
            renderPreviews();
            document.getElementById('fileInput').value = '';
            
            const procHandle = showProcessing();

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: history,
                        systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] }
                    })
                });

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts[0]?.text || "Error.";
                
                hideProcessing(procHandle);
                appendAIMessage(aiText);
                chatHistory.push({ role: 'user', parts: parts });
                chatHistory.push({ role: 'model', parts: [{ text: aiText }] });

            } catch (err) {
                hideProcessing(procHandle);
                appendAIMessage(`Error: ${err.message}`);
            }
        }

        function handleFileUpload(input) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    activeFiles.push({
                        mimeType: file.type,
                        name: file.name,
                        data: e.target.result.split(',')[1]
                    });
                    renderPreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const area = document.getElementById('previewArea');
            area.innerHTML = '';
            
            if(activeFiles.length > 0 || activeUrls.length > 0) {
                area.classList.remove('hidden');
                activeFiles.forEach((f, idx) => {
                    const badge = document.createElement('div');
                    badge.className = "bg-slate-700 text-xs px-2 py-1 rounded flex items-center gap-2 border border-white/20 text-slate-200";
                    badge.innerHTML = `<i data-lucide="file" class="w-3 h-3"></i> ${f.name} <i data-lucide="x" class="remove-item w-3 h-3" onclick="removeFile(${idx})"></i>`;
                    area.appendChild(badge);
                });
                activeUrls.forEach((u, idx) => {
                    const badge = document.createElement('div');
                    badge.className = "bg-green-900/40 text-xs px-2 py-1 rounded flex items-center gap-2 border border-green-500/30 text-green-200";
                    badge.innerHTML = `<i data-lucide="link" class="w-3 h-3"></i> URL ${idx+1} <i data-lucide="x" class="remove-item w-3 h-3" onclick="removeUrl(${idx})"></i>`;
                    area.appendChild(badge);
                });
            } else {
                area.classList.add('hidden');
            }
            lucide.createIcons();
        }

        const ui = document.getElementById('userInput');
        ui.addEventListener('input', function() {
            this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
        });
        
        if (apiKey) document.getElementById('apiKeyInput').value = apiKey;
        lucide.createIcons();

        marked.use({
            renderer: {
                code(code, language) {
                    const validLang = language || 'plaintext';
                    return `<div class="mac-terminal" data-code="${encodeURIComponent(code)}" data-lang="${validLang}">
                                <div class="mac-header">
                                    <div class="flex gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><div class="w-3 h-3 rounded-full bg-yellow-500"></div><div class="w-3 h-3 rounded-full bg-green-500"></div></div>
                                    <span class="text-xs text-slate-400 font-mono">${validLang}</span>
                                </div>
                                <pre><code class="hljs language-${validLang}">${code}</code></pre>
                            </div>`;
                }
            }
        });
    </script>
</body>
</html>
